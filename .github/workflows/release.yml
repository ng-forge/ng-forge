name: Release

on:
  push:
    branches: ['release-*']
  workflow_dispatch:
    inputs:
      mode:
        description: 'Release mode'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run
          - publish

permissions:
  contents: write
  id-token: write
  actions: read

env:
  LIBRARY_PACKAGES: 'dynamic-forms dynamic-forms-material dynamic-forms-bootstrap dynamic-forms-ionic dynamic-forms-primeng dynamic-form-mcp'

jobs:
  # This job runs on push and skips immediately - just to show the workflow in PR
  await-dispatch:
    name: Awaiting manual trigger
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Skip
        run: |
          echo "â„¹ï¸ Release workflow is ready."
          echo "To release, go to Actions â†’ Release â†’ Run workflow on this branch."
          echo "Select 'publish' mode to publish to npm."

  check-ci:
    name: Verify CI Passed
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Check CI workflow status
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');

            console.log(`Checking CI status for branch: ${branch}`);

            // Get the latest CI workflow run for this branch
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'ci.yml',
              branch,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No CI workflow runs found for branch ${branch}. Push to the branch first to trigger CI.`);
              return;
            }

            const latestRun = runs.data.workflow_runs[0];
            console.log(`Latest CI run: ${latestRun.html_url}`);
            console.log(`Status: ${latestRun.status}, Conclusion: ${latestRun.conclusion}`);

            if (latestRun.status !== 'completed') {
              core.setFailed(`CI is still running. Wait for it to complete before releasing.`);
              return;
            }

            if (latestRun.conclusion !== 'success') {
              core.setFailed(`CI failed with conclusion: ${latestRun.conclusion}. Fix CI before releasing.`);
              return;
            }

            // Verify the CI run is for the same commit
            const currentSha = context.sha;
            if (latestRun.head_sha !== currentSha) {
              console.log(`Warning: CI ran on ${latestRun.head_sha}, current is ${currentSha}`);
              core.setFailed(`CI was run on a different commit. Push your changes and wait for CI to pass.`);
              return;
            }

            console.log('âœ… CI passed for the current commit!');

  release:
    name: Release Libraries
    runs-on: ubuntu-latest
    needs: check-ci

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./packages/dynamic-forms/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Releasing version: $VERSION"

      - name: Build libraries
        run: pnpm nx run-many -t build -p ${{ env.LIBRARY_PACKAGES }}

      - name: Verify build outputs
        run: |
          echo "Verifying build outputs..."
          for pkg in ${{ env.LIBRARY_PACKAGES }}; do
            if [ ! -d "dist/packages/$pkg" ]; then
              echo "âŒ Build output missing for $pkg"
              exit 1
            fi
            echo "âœ… $pkg"
          done

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate Changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -50)
          else
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          cat > RELEASE_NOTES.md <<EOF
          ## What's Changed

          ${CHANGELOG}

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG:-initial}...v${{ env.VERSION }}
          EOF

      - name: Create Git Tag
        run: |
          if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "âŒ Tag v${{ env.VERSION }} already exists!"
            exit 1
          fi
          git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to npm (dry-run)
        if: ${{ inputs.mode == 'dry-run' }}
        run: pnpm nx release publish --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: ${{ inputs.mode == 'publish' }}
        run: pnpm nx release publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          echo "## Release v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published packages:" >> $GITHUB_STEP_SUMMARY
          for pkg in ${{ env.LIBRARY_PACKAGES }}; do
            echo "- \`@ng-forge/$pkg@${{ env.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }})" >> $GITHUB_STEP_SUMMARY
          echo "- [npm](https://www.npmjs.com/package/@ng-forge/dynamic-forms/v/${{ env.VERSION }})" >> $GITHUB_STEP_SUMMARY
