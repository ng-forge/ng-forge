name: PR Check

on:
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  LIBRARY_PACKAGES: 'dynamic-forms dynamic-forms-material dynamic-forms-bootstrap dynamic-forms-ionic dynamic-forms-primeng dynamic-form-mcp'
  NODE_MODULES_CACHE_KEY: modules-${{ github.run_id }}
  PLAYWRIGHT_CACHE_KEY: playwright-${{ github.run_id }}

jobs:
  # This job determines if the workflow should run
  should-run:
    name: Check if should run
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should-skip: ${{ steps.check.outputs.should-skip }}
    steps:
      - name: Check if release branch
        id: check
        run: |
          if [[ "${{ github.head_ref }}" == release-* ]]; then
            echo "should-skip=true" >> $GITHUB_OUTPUT
            echo "Skipping PR check for release branch: ${{ github.head_ref }}"
          else
            echo "should-skip=false" >> $GITHUB_OUTPUT
          fi

  setup:
    name: Setup
    needs: should-run
    if: needs.should-run.outputs.should-skip != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache node_modules
        uses: actions/cache/save@v5
        with:
          path: node_modules
          key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Cache Playwright browsers
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ env.PLAYWRIGHT_CACHE_KEY }}

  checks:
    name: Checks
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch for affected detection
        run: git fetch origin main:main

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Validate PR title
        run: |
          echo "Validating PR title against Angular convention..."
          echo "${{ github.event.pull_request.title }}" | pnpm commitlint --verbose

      - name: Check formatting on affected files
        run: |
          echo "Checking code formatting on affected files..."
          AFFECTED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/main...HEAD | grep -E '\.(ts|js|json|md|yml|yaml|html|css|scss)$' || true)
          if [ -z "$AFFECTED_FILES" ]; then
            echo "No affected files to check"
            exit 0
          fi
          echo "Affected files to check:"
          echo "$AFFECTED_FILES"
          echo ""
          echo "$AFFECTED_FILES" | xargs pnpm exec prettier --check || {
            echo ""
            echo "❌ Formatting issues found in affected files!"
            echo "Run 'pnpm exec prettier --write .' to fix formatting issues"
            exit 1
          }

      - name: Validate dependency graph
        run: |
          echo "Checking for circular dependencies..."
          pnpm nx graph --file=graph.json || {
            echo "❌ Failed to generate dependency graph"
            exit 1
          }
          echo "✅ Dependency graph is valid"
          echo ""
          echo "Affected projects and their dependents:"
          pnpm nx show projects --affected --base=origin/main --with-target=build || true

  build:
    name: Build & Verify
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch for affected detection
        run: git fetch origin main:main

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Build affected libraries
        run: pnpm nx affected -t build --base=origin/main

      - name: Verify package integrity
        run: |
          echo "Verifying package integrity..."
          for PKG in ${{ env.LIBRARY_PACKAGES }}; do
            if [ -d "dist/packages/$PKG" ]; then
              echo "Checking dist/packages/$PKG..."
              if [ ! -f "dist/packages/$PKG/package.json" ]; then
                echo "❌ Missing package.json in dist/packages/$PKG"
                exit 1
              fi
              # MCP package has Node.js structure (not Angular)
              if [ "$PKG" = "dynamic-form-mcp" ]; then
                if [ ! -f "dist/packages/$PKG/src/index.js" ]; then
                  echo "❌ Missing src/index.js in dist/packages/$PKG"
                  exit 1
                fi
                echo "✅ $PKG package structure looks valid (MCP server)"
              elif [ ! -f "dist/packages/$PKG/index.d.ts" ] && [ ! -f "dist/packages/$PKG/fesm2022/index.d.ts" ]; then
                echo "⚠️  Warning: No index.d.ts found in dist/packages/$PKG"
              else
                echo "✅ $PKG package structure looks valid"
              fi
            else
              echo "⏭️  Skipping $PKG (not built or not affected)"
            fi
          done
          echo "✅ Package integrity check complete"

      - name: Cache build artifacts
        uses: actions/cache@v5
        with:
          path: |
            dist/packages/dynamic-forms
            dist/packages/dynamic-forms-material
            dist/packages/dynamic-forms-bootstrap
            dist/packages/dynamic-forms-ionic
            dist/packages/dynamic-forms-primeng
            dist/packages/dynamic-form-mcp
          key: build-${{ github.sha }}-${{ hashFiles('packages/**') }}

  quality:
    name: Lint
    needs: [setup, build]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch for affected detection
        run: git fetch origin main:main

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Restore build artifacts
        uses: actions/cache@v5
        with:
          path: |
            dist/packages/dynamic-forms
            dist/packages/dynamic-forms-material
            dist/packages/dynamic-forms-bootstrap
            dist/packages/dynamic-forms-ionic
            dist/packages/dynamic-forms-primeng
            dist/packages/dynamic-form-mcp
          key: build-${{ github.sha }}-${{ hashFiles('packages/**') }}

      - name: Lint affected projects
        run: pnpm nx affected -t lint --base=origin/main

  test:
    name: Unit Tests
    needs: [setup, build]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch for affected detection
        run: git fetch origin main:main

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Restore Playwright browsers
        uses: actions/cache/restore@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ env.PLAYWRIGHT_CACHE_KEY }}
          fail-on-cache-miss: true

      - name: Restore build artifacts
        uses: actions/cache@v5
        with:
          path: |
            dist/packages/dynamic-forms
            dist/packages/dynamic-forms-material
            dist/packages/dynamic-forms-bootstrap
            dist/packages/dynamic-forms-ionic
            dist/packages/dynamic-forms-primeng
            dist/packages/dynamic-form-mcp
          key: build-${{ github.sha }}-${{ hashFiles('packages/**') }}

      - name: Test affected projects
        run: pnpm nx affected -t test --base=origin/main --configuration=ci --coverage

      - name: Type test affected projects
        run: pnpm nx affected -t type-test --base=origin/main

  build-apps:
    name: Build Apps
    needs: [setup, build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      e2e-matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-e2e: ${{ steps.set-matrix.outputs.has-e2e }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch for affected detection
        run: git fetch origin main:main

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Restore build artifacts
        uses: actions/cache@v5
        with:
          path: |
            dist/packages/dynamic-forms
            dist/packages/dynamic-forms-material
            dist/packages/dynamic-forms-bootstrap
            dist/packages/dynamic-forms-ionic
            dist/packages/dynamic-forms-primeng
            dist/packages/dynamic-form-mcp
          key: build-${{ github.sha }}-${{ hashFiles('packages/**') }}

      - name: Build docs if affected
        run: |
          if pnpm nx show projects --affected --base=origin/main | grep -q docs; then
            echo "Building documentation..."
            pnpm nx build docs --configuration=production
          else
            echo "Documentation not affected, skipping build"
          fi

      - name: Build affected example apps
        run: |
          AFFECTED=$(pnpm nx show projects --affected --base=origin/main)
          EXAMPLES=$(echo "$AFFECTED" | grep -E "(core-examples|material-examples|bootstrap-examples|primeng-examples|ionic-examples)" || true)
          if [ -n "$EXAMPLES" ]; then
            echo "Building affected example apps:"
            echo "$EXAMPLES"
            for APP in $EXAMPLES; do
              echo "Building $APP..."
              pnpm nx build $APP --configuration=production
            done
          else
            echo "No example apps affected, skipping build"
          fi

      - name: Determine E2E matrix
        id: set-matrix
        run: |
          AFFECTED=$(pnpm nx show projects --affected --base=origin/main --with-target=e2e 2>/dev/null || echo "")
          echo "Affected E2E projects: $AFFECTED"

          # Build JSON matrix
          MATRIX='{"include":['
          FIRST=true

          for APP in core-examples bootstrap-examples material-examples primeng-examples ionic-examples; do
            if echo "$AFFECTED" | grep -q "$APP"; then
              SHORT=$(echo "$APP" | sed 's/-examples//')
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX+=','
              fi
              MATRIX+="{\"app\":\"$APP\",\"short\":\"$SHORT\"}"
              echo "  - $APP (affected)"
            else
              echo "  - $APP (not affected, skipping)"
            fi
          done

          MATRIX+=']}'

          if [ "$MATRIX" = '{"include":[]}' ]; then
            echo "No E2E apps affected"
            echo "has-e2e=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            echo "E2E matrix: $MATRIX"
            echo "has-e2e=true" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  mcp-registry:
    name: MCP Registry Check
    needs: [setup, build]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node and restore cache
        uses: ./.github/actions/setup-node-restore
        with:
          cache-key: ${{ env.NODE_MODULES_CACHE_KEY }}

      - name: Check MCP registry is up to date
        run: |
          # Run generate-registry to regenerate files
          pnpm nx run dynamic-form-mcp:generate-registry

          # Check for uncommitted changes in registry files
          if git diff --quiet packages/dynamic-form-mcp/src/registry/*.json; then
            echo "✅ MCP registry files are up to date"
          else
            echo "❌ MCP registry files are out of date!"
            echo ""
            echo "Changed files:"
            git diff --name-only packages/dynamic-form-mcp/src/registry/*.json
            echo ""
            echo "Run 'pnpm nx run dynamic-form-mcp:generate-registry' and commit the changes."
            echo ""
            echo "Diff:"
            git diff packages/dynamic-form-mcp/src/registry/*.json
            exit 1
          fi

  e2e:
    name: E2E Tests (${{ matrix.app }})
    needs: [quality, test, build-apps]
    if: needs.build-apps.outputs.has-e2e == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-apps.outputs.e2e-matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Docker handles everything - no need for pnpm/node setup on host
      - name: Run E2E tests in Docker
        id: e2e
        run: ./scripts/playwright-docker.sh ${{ matrix.app }}

      - name: Generate job summary
        if: always() && steps.e2e.outcome != 'skipped'
        run: node scripts/playwright-job-summary.mjs ${{ matrix.app }} apps/examples/${{ matrix.short }}/test-results

      - name: Upload test artifacts on failure
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-results-${{ matrix.app }}
          path: |
            apps/examples/${{ matrix.short }}/test-results/
            apps/examples/${{ matrix.short }}/playwright-report/
          if-no-files-found: ignore
          retention-days: 7

  ci-success:
    name: PR Check Complete
    if: always()
    needs: [should-run, setup, checks, build, quality, test, mcp-registry, build-apps, e2e]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Verify all jobs succeeded
        uses: re-actors/alls-green@release/v1
        with:
          # e2e may be skipped if no E2E apps are affected
          allowed-skips: setup, checks, build, quality, test, mcp-registry, build-apps, e2e
          jobs: ${{ toJSON(needs) }}
