name: Deploy to Vercel

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

permissions:
  contents: read

concurrency:
  group: 'vercel-deploy'
  cancel-in-progress: false

jobs:
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      ci-success: ${{ steps.check.outputs.success }}
    steps:
      - name: Check latest CI run
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            // Get the branch that triggered this workflow
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`Checking CI status for branch: ${branch}`);

            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'completed',
              per_page: 1
            });

            if (runs.total_count === 0) {
              core.setFailed(`No CI runs found for branch: ${branch}`);
              return;
            }

            const latestRun = runs.workflow_runs[0];
            console.log(`Latest CI run on ${branch}: ${latestRun.conclusion} (${latestRun.html_url})`);

            if (latestRun.conclusion === 'success') {
              core.setOutput('success', 'true');
            } else {
              core.setFailed(`Latest CI run failed on ${branch}: ${latestRun.html_url}`);
            }

  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: check-ci
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=${{ inputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build ${{ inputs.environment == 'production' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          else
            URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      - name: Smoke test deployment
        if: inputs.environment == 'production'
        run: |
          echo "Verifying deployment is accessible..."
          curl --fail --retry 5 --retry-delay 10 "https://ng-forge.com/dynamic-forms/" > /dev/null
          echo "Deployment verified successfully"

      - name: Output Deployment URL
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs:** ${{ steps.deploy.outputs.url }}/dynamic-forms/" >> $GITHUB_STEP_SUMMARY
          echo "- **Material Examples:** ${{ steps.deploy.outputs.url }}/dynamic-forms/examples/material/" >> $GITHUB_STEP_SUMMARY
          echo "- **Bootstrap Examples:** ${{ steps.deploy.outputs.url }}/dynamic-forms/examples/bootstrap/" >> $GITHUB_STEP_SUMMARY
          echo "- **PrimeNG Examples:** ${{ steps.deploy.outputs.url }}/dynamic-forms/examples/primeng/" >> $GITHUB_STEP_SUMMARY
          echo "- **Ionic Examples:** ${{ steps.deploy.outputs.url }}/dynamic-forms/examples/ionic/" >> $GITHUB_STEP_SUMMARY
